# ============================================
# LABSOC HOME - Main Pipeline (Beats Input)
# Handles: Filebeat, Auditbeat, Metricbeat
# ============================================

input {
  beats {
    port => 5044
    ssl => false
  }
}

filter {
  # Add LabSOC metadata
  mutate {
    add_field => {
      "[@metadata][labsoc]" => "true"
      "[labsoc][pipeline]" => "main"
    }
  }

  # ============================================
  # AUDITBEAT Processing (HIDS)
  # ============================================
  if [agent][type] == "auditbeat" {
    mutate {
      add_field => {
        "[labsoc][source]" => "auditbeat"
        "[labsoc][data_type]" => "hids"
      }
    }

    # File Integrity Monitoring (FIM) events
    if [event][module] == "file_integrity" {
      mutate {
        add_field => {
          "[event][kind]" => "alert"
          "[event][category]" => "file"
        }
      }
      
      # Critical file changes
      if [event][action] in ["updated", "deleted", "created"] {
        if [file][path] =~ /\.(ssh|aws|kube|gnupg)/ or [file][path] =~ /(passwd|shadow|sudoers)/ {
          mutate {
            add_field => {
              "[event][severity]" => "critical"
              "[labsoc][alert_type]" => "critical_file_change"
            }
          }
        } else {
          mutate {
            add_field => {
              "[event][severity]" => "medium"
              "[labsoc][alert_type]" => "file_change"
            }
          }
        }
      }
    }

    # Login events
    if [event][dataset] == "system.login" {
      mutate {
        add_field => {
          "[event][kind]" => "event"
          "[event][category]" => "authentication"
        }
      }
      if [event][outcome] == "failure" {
        mutate {
          add_field => {
            "[event][severity]" => "high"
            "[labsoc][alert_type]" => "failed_login"
          }
        }
      }
    }

    # Process events - suspicious activity
    if [event][dataset] == "system.process" {
      if [process][name] =~ /(?i)(nc|netcat|ncat|socat|nmap|masscan)/ {
        mutate {
          add_field => {
            "[event][severity]" => "high"
            "[labsoc][alert_type]" => "suspicious_process"
            "[event][kind]" => "alert"
          }
        }
      }
    }

    # Socket events - network connections
    if [event][dataset] == "system.socket" {
      mutate {
        add_field => {
          "[event][kind]" => "event"
          "[event][category]" => "network"
        }
      }
    }
  }

  # ============================================
  # FILEBEAT Processing
  # ============================================
  if [agent][type] == "filebeat" {
    mutate {
      add_field => {
        "[labsoc][source]" => "filebeat"
      }
    }
  }

  # ============================================
  # Common Processing
  # ============================================
  
  # Parse timestamp
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
      target => "@timestamp"
    }
  }

  # GeoIP enrichment for source IPs
  if [source][ip] {
    geoip {
      source => "[source][ip]"
      target => "[source][geo]"
    }
  }

  # GeoIP enrichment for destination IPs
  if [destination][ip] {
    geoip {
      source => "[destination][ip]"
      target => "[destination][geo]"
    }
  }
}

output {
  # Route Auditbeat to dedicated index
  if [agent][type] == "auditbeat" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "labsoc-auditbeat-%{+YYYY.MM.dd}"
    }
  }
  # Route other beats to generic index
  else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "labsoc-beats-%{+YYYY.MM.dd}"
    }
  }
}
