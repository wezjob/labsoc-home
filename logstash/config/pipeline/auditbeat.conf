# ============================================
# LABSOC HOME - Auditbeat Pipeline
# Host-based security events from Auditbeat
# ============================================

input {
  beats {
    port => 5044
    tags => ["beats"]
  }
}

filter {
  # Only process auditbeat events
  if [agent][type] == "auditbeat" or [labsoc][source] == "auditbeat" {
    
    # Add labsoc metadata
    mutate {
      add_field => {
        "[labsoc][source]" => "auditbeat"
        "[labsoc][pipeline]" => "hids"
      }
    }

    # Process file integrity events
    if [event][module] == "file_integrity" {
      mutate {
        add_field => {
          "[event][kind]" => "alert"
          "[event][category]" => "file"
        }
      }
      
      # Detect changes to critical files
      if [event][action] == "updated" or [event][action] == "deleted" {
        mutate {
          add_field => {
            "[event][severity]" => "high"
            "[labsoc][alert_type]" => "fim_change"
          }
        }
      }
      
      # Critical path alerts (SSH keys, etc.)
      if [file][path] =~ /\.ssh/ or [file][path] =~ /passwd/ or [file][path] =~ /shadow/ {
        mutate {
          replace => {
            "[event][severity]" => "critical"
          }
          add_field => {
            "[labsoc][alert_type]" => "critical_file_change"
          }
        }
      }
    }

    # Process system events
    if [event][module] == "system" {
      
      # Login events
      if [event][dataset] == "login" {
        mutate {
          add_field => {
            "[event][kind]" => "event"
            "[event][category]" => "authentication"
          }
        }
        
        # Failed logins
        if [event][outcome] == "failure" {
          mutate {
            add_field => {
              "[event][severity]" => "medium"
              "[labsoc][alert_type]" => "failed_login"
            }
          }
        }
      }
      
      # Process events
      if [event][dataset] == "process" {
        mutate {
          add_field => {
            "[event][kind]" => "event"
            "[event][category]" => "process"
          }
        }
        
        # Suspicious processes
        if [process][name] =~ /(?i)(nc|netcat|ncat|socat|wget|curl)/ and [user][name] != "root" {
          mutate {
            add_field => {
              "[event][severity]" => "medium"
              "[labsoc][alert_type]" => "suspicious_process"
            }
          }
        }
      }
      
      # Socket/Network events
      if [event][dataset] == "socket" {
        mutate {
          add_field => {
            "[event][kind]" => "event"
            "[event][category]" => "network"
          }
        }
      }
    }

    # Normalize timestamps
    if [event][created] {
      date {
        match => [ "[event][created]", "ISO8601" ]
        target => "@timestamp"
      }
    }
  }
}

output {
  if [labsoc][source] == "auditbeat" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "labsoc-auditbeat-%{+YYYY.MM.dd}"
    }
  }
}
