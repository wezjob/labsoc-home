# ============================================================
# MODULE: VULNERABILITY AUDIT & SCANNING
# NIST Function: PROTECT (PR.IP - Security Continuous Monitoring)
# ============================================================
# Components: OpenVAS/Greenbone, Nuclei, OWASP ZAP
# ============================================================

services:
  # ============================================================
  # Greenbone OpenVAS - Vulnerability Scanner
  # ============================================================
  openvas:
    image: greenbone/openvas-scanner:latest
    container_name: labsoc-openvas-scanner
    restart: unless-stopped
    volumes:
      - openvas_data:/var/lib/openvas
    networks:
      - labsoc-network

  gvmd:
    image: greenbone/gvmd:latest
    container_name: labsoc-gvmd
    restart: unless-stopped
    depends_on:
      - openvas
      - postgres-gvm
      - redis-gvm
    environment:
      - GVMD_USER=admin
      - GVMD_PASSWORD=${OPENVAS_ADMIN_PASSWORD:-OpenVAS2026!}
    volumes:
      - gvmd_data:/var/lib/gvm
      - openvas_data:/var/lib/openvas
    networks:
      - labsoc-network

  postgres-gvm:
    image: greenbone/pg-gvm:latest
    container_name: labsoc-postgres-gvm
    restart: unless-stopped
    volumes:
      - postgres_gvm_data:/var/lib/postgresql
    networks:
      - labsoc-network

  redis-gvm:
    image: greenbone/redis-server:latest
    container_name: labsoc-redis-gvm
    restart: unless-stopped
    networks:
      - labsoc-network

  gsa:
    image: greenbone/gsa:latest
    container_name: labsoc-gsa
    restart: unless-stopped
    depends_on:
      - gvmd
    ports:
      - "9392:9392"  # Greenbone Security Assistant Web UI
    networks:
      - labsoc-network
    labels:
      - "labsoc.module=vulnerability-audit"
      - "labsoc.nist=PROTECT"

  # ============================================================
  # Nuclei - Fast Vulnerability Scanner
  # ============================================================
  nuclei:
    image: projectdiscovery/nuclei:latest
    container_name: labsoc-nuclei
    restart: unless-stopped
    entrypoint: ["tail", "-f", "/dev/null"]
    volumes:
      - nuclei_templates:/root/nuclei-templates
      - nuclei_output:/output
      - ./nuclei-config:/root/.config/nuclei
    networks:
      - labsoc-network
    labels:
      - "labsoc.module=vulnerability-audit"
      - "labsoc.nist=PROTECT"

  # ============================================================
  # OWASP ZAP - Web Application Scanner
  # ============================================================
  zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: labsoc-zap
    restart: unless-stopped
    command: zap-webswing.sh
    volumes:
      - zap_data:/zap/wrk
    ports:
      - "8004:8080"  # ZAP Web UI
      - "8090:8090"  # ZAP API
    networks:
      - labsoc-network
    labels:
      - "labsoc.module=vulnerability-audit"
      - "labsoc.nist=PROTECT"

  # ============================================================
  # Trivy - Container/IaC Scanner
  # ============================================================
  trivy:
    image: aquasec/trivy:latest
    container_name: labsoc-trivy
    restart: unless-stopped
    entrypoint: ["tail", "-f", "/dev/null"]
    volumes:
      - trivy_cache:/root/.cache/trivy
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - labsoc-network
    labels:
      - "labsoc.module=vulnerability-audit"
      - "labsoc.nist=PROTECT"

networks:
  labsoc-network:
    external: true

volumes:
  openvas_data:
  gvmd_data:
  postgres_gvm_data:
  nuclei_templates:
  nuclei_output:
  zap_data:
  trivy_cache:
